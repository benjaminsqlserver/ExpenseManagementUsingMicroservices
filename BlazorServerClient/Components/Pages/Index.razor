@page "/"
@using ExpenseManagement.BlazorUI.Services
@using ExpenseManagement.BlazorUI.Models
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject IExpenseService ExpenseService

<PageTitle>Dashboard - Expense Management</PageTitle>

<RadzenText TextStyle="TextStyle.H3" class="rz-mb-4">Dashboard</RadzenText>

<RadzenRow Gap="1rem">
    <RadzenColumn Size="12" SizeMD="3">
        <RadzenCard Style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <RadzenStack Gap="0.5rem">
                <RadzenText TextStyle="TextStyle.Overline">TOTAL EXPENSES</RadzenText>
                <RadzenText TextStyle="TextStyle.H4" Style="font-weight: 600;">@totalExpenses</RadzenText>
                <RadzenText TextStyle="TextStyle.Body2">This month</RadzenText>
            </RadzenStack>
        </RadzenCard>
    </RadzenColumn>

    <RadzenColumn Size="12" SizeMD="3">
        <RadzenCard Style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
            <RadzenStack Gap="0.5rem">
                <RadzenText TextStyle="TextStyle.Overline">PENDING APPROVAL</RadzenText>
                <RadzenText TextStyle="TextStyle.H4" Style="font-weight: 600;">@pendingCount</RadzenText>
                <RadzenText TextStyle="TextStyle.Body2">Awaiting review</RadzenText>
            </RadzenStack>
        </RadzenCard>
    </RadzenColumn>

    <RadzenColumn Size="12" SizeMD="3">
        <RadzenCard Style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
            <RadzenStack Gap="0.5rem">
                <RadzenText TextStyle="TextStyle.Overline">APPROVED</RadzenText>
                <RadzenText TextStyle="TextStyle.H4" Style="font-weight: 600;">@approvedAmount.ToString("C")</RadzenText>
                <RadzenText TextStyle="TextStyle.Body2">This month</RadzenText>
            </RadzenStack>
        </RadzenCard>
    </RadzenColumn>

    <RadzenColumn Size="12" SizeMD="3">
        <RadzenCard Style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white;">
            <RadzenStack Gap="0.5rem">
                <RadzenText TextStyle="TextStyle.Overline">REIMBURSED</RadzenText>
                <RadzenText TextStyle="TextStyle.H4" Style="font-weight: 600;">@reimbursedAmount.ToString("C")</RadzenText>
                <RadzenText TextStyle="TextStyle.Body2">This month</RadzenText>
            </RadzenStack>
        </RadzenCard>
    </RadzenColumn>
</RadzenRow>

<RadzenRow Gap="1rem" class="rz-mt-4">
    <RadzenColumn Size="12" SizeMD="8">
        <RadzenCard>
            <RadzenText TextStyle="TextStyle.H6" class="rz-mb-4">Recent Expenses</RadzenText>
            @if (recentExpenses != null && recentExpenses.Any())
            {
                <RadzenDataList Data="@recentExpenses" TItem="ExpenseDto">
                    <Template Context="expense">
                        <RadzenCard Variant="Variant.Outlined" class="rz-mb-2">
                            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                                <RadzenStack Gap="0.25rem">
                                    <RadzenText TextStyle="TextStyle.Subtitle1" Style="font-weight: 600;">@expense.Title</RadzenText>
                                    <RadzenText TextStyle="TextStyle.Body2" class="rz-text-secondary-color">
                                        @expense.ExpenseDate.ToString("MMM dd, yyyy")
                                    </RadzenText>
                                </RadzenStack>
                                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
                                    <RadzenText TextStyle="TextStyle.H6" Style="font-weight: 600;">
                                        @expense.Currency @expense.TotalAmount.ToString("N2")
                                    </RadzenText>
                                    <RadzenBadge Text="@expense.Status.ToString()" BadgeStyle="@GetStatusBadgeStyle(expense.Status)" />
                                </RadzenStack>
                            </RadzenStack>
                        </RadzenCard>
                    </Template>
                </RadzenDataList>
            }
            else
            {
                <RadzenText TextStyle="TextStyle.Body2" class="rz-text-secondary-color">No recent expenses</RadzenText>
            }
        </RadzenCard>
    </RadzenColumn>

    <RadzenColumn Size="12" SizeMD="4">
        <RadzenCard>
            <RadzenText TextStyle="TextStyle.H6" class="rz-mb-4">Quick Actions</RadzenText>
            <RadzenStack Gap="0.5rem">
                <RadzenButton Text="Create Expense" Icon="add_circle" ButtonStyle="ButtonStyle.Success" Style="width: 100%;" Click="@(() => NavigationManager.NavigateTo("/expenses/create"))" />
                <RadzenButton Text="View All Expenses" Icon="list" ButtonStyle="ButtonStyle.Primary" Variant="Variant.Outlined" Style="width: 100%;" Click="@(() => NavigationManager.NavigateTo("/expenses"))" />
                <RadzenButton Text="View Reports" Icon="assessment" ButtonStyle="ButtonStyle.Info" Variant="Variant.Outlined" Style="width: 100%;" Click="@(() => NavigationManager.NavigateTo("/reports"))" />
            </RadzenStack>
        </RadzenCard>
    </RadzenColumn>
</RadzenRow>

@code {
    @inject NavigationManager NavigationManager

    private int totalExpenses = 0;
    private int pendingCount = 0;
    private decimal approvedAmount = 0;
    private decimal reimbursedAmount = 0;
    private List<ExpenseDto>? recentExpenses;

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        try
        {
            var result = await ExpenseService.GetExpensesAsync(1, 5);
            recentExpenses = result.Items;
            totalExpenses = result.TotalCount;

            pendingCount = recentExpenses?.Count(e => e.Status == ExpenseStatus.PendingApproval) ?? 0;
            approvedAmount = recentExpenses?.Where(e => e.Status == ExpenseStatus.Approved).Sum(e => e.TotalAmount) ?? 0;
            reimbursedAmount = recentExpenses?.Where(e => e.Status == ExpenseStatus.Reimbursed).Sum(e => e.TotalAmount) ?? 0;
        }
        catch (Exception ex)
        {
            // Handle error
        }
    }

    private BadgeStyle GetStatusBadgeStyle(ExpenseStatus status)
    {
        return status switch
        {
            ExpenseStatus.Draft => BadgeStyle.Light,
            ExpenseStatus.Submitted => BadgeStyle.Info,
            ExpenseStatus.PendingApproval => BadgeStyle.Warning,
            ExpenseStatus.Approved => BadgeStyle.Success,
            ExpenseStatus.Rejected => BadgeStyle.Danger,
            ExpenseStatus.Reimbursed => BadgeStyle.Success,
            _ => BadgeStyle.Secondary
        };
    }
}